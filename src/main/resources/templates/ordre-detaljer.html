<!-- se siden her: http://localhost:7070/admin/ordre/1 -->

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ordredetaljer</title>
    <link rel="icon" href="/images/fogfavicon.png" type="image/png"/>
    <link href="../public/css/styles.css" th:href="@{/css/styles.css}" rel="stylesheet"/>

    <script>
        function toggleShedFields() {
            const shedToggle = document.getElementById('shedToggle');
            const shedFields = document.getElementById('shedFields');

            if (shedToggle.value === 'with') {
                shedFields.style.display = 'block';
            } else {
                shedFields.style.display = 'none';
            }
        }

        window.addEventListener("DOMContentLoaded", function () {
            // Toggle
            toggleShedFields();

            // If shed-fields have values, the shed is automatically shown
            const shedWidth = document.querySelector('input[name="shedWidth"]');
            const shedLength = document.querySelector('input[name="shedLength"]');

            if (shedWidth && shedLength && (shedWidth.value !== "" && shedWidth.value !== "0") && (shedLength.value !== "" && shedLength.value !== "0")) {
                document.getElementById("shedToggle").value = "with";
                document.getElementById("shedFields").style.display = "block";
            }
        });

        function updateSketch() {
            const form = document.getElementById("carportForm");
            const formData = new FormData(form);

            fetch("/update-sketch", {
                method: "POST",
                body: formData,
            })
                .then(response => response.text())
                .then(svg => {
                    document.querySelector(".carport-svg-topview > div").innerHTML = svg;
                })
                .catch(error => console.error("Error:", error));
        }

            function calculateProfitAndMargin() {
            const price = parseFloat(document.getElementById("orderPrice").value.replace(",", "."));
            const costPrice = parseFloat(document.getElementById("costPriceDisplay").innerText.replace(" kr", "").replace(",", "."));

            if (!isNaN(price) && !isNaN(costPrice) && costPrice > 0) {
            const profit = price - costPrice;
            const margin = (profit / price) * 100;

            document.getElementById("profitDisplay").innerText = profit.toFixed(2) + " kr";
            document.getElementById("marginDisplay").innerText = margin.toFixed(1) + " %";
        } else {
            document.getElementById("profitDisplay").innerText = "0 kr";
            document.getElementById("marginDisplay").innerText = "0%";
        }
        }

            document.addEventListener("DOMContentLoaded", () => {
            // initial calculation
            calculateProfitAndMargin();

            // calculate again when price is changed
            document.getElementById("orderPrice").addEventListener("input", calculateProfitAndMargin);
        });


    window.addEventListener("DOMContentLoaded", function () {
    toggleShedFields(); // hvis du allerede bruger denne
    updateProfitAndMargin(); // start beregning
    });

    </script>

</head>
<body>
<div class="container">
    <header>
        <div class="container header-content">
            <div class="header-logo">
                <a href="/" th:href="@{/}">
                    <img src="../public/images/fog_logo.png" th:src="@{/images/fog_logo.png}" alt="Johannes Fog Logo"/>
                </a>
            </div>
            <nav>
                <a th:href="@{/admin/orders}">Ordrer</a>
            </nav>
            <div class="header-logout" style="margin-left:auto;">
                <a th:href="@{/logout}">Log ud</a>
            </div>
        </div>
    </header>
</div>

<main>
    <div class="container">
        <p>Sælger: <span
                th:text="${order.salesperson != null ? order.salesperson.name : 'Ukendt sælger'}">Ukendt sælger</span>
        </p>

        <section class="orders-section">
            <h1 th:text="${order.customer.name}">Kundenavn</h1>
            <p th:text="${order.customer.address}">Adresse</p>
            <p th:text="${order.customer.zip} + ' ' + ${order.customer.city}">Postnummer og by</p>
            <p th:text="'Tlf: ' + ${order.customer.phoneNumber}">Telefon</p>
            <p th:text="'Email: ' + ${order.customer.email}">Email</p>

            <p>Ordre nr: <span th:text="${order.orderId}">0000</span></p>
            <p>Status: <span th:text="${order.status}">Status</span></p>
            <p th:text="'Ordredato: ' + ${order.orderDate != null ? #temporals.format(order.orderDate, 'dd/MM/yyyy') : 'Ingen dato'}">
                Ordredato</p>

            <!-- Carport form -->
            <form id="carportForm" th:action="@{/admin/update-order}" method="post">
                <div class="form-section">
                    <h2>Carport</h2>
                    <label>Carport bredde
                        <input type="number" name="carportWidth" th:value="${order.carportWidth}" required/>
                    </label>
                    <label>Carport længde
                        <input type="number" name="carportLength" th:value="${order.carportLength}" required/>
                    </label>
                    <label>Carport bredde
                        <input type="number" name="carportHeight" th:value="${order.carportHeight}" required/>
                    </label>

                    <!-- Shed Section -->
                    <div class="form-section">
                        <h2>Skur</h2>
                        <label>Redskabsrum
                            <select id="shedToggle" name="shedToggle" onchange="toggleShedFields()">
                                <option value="none" selected>Uden redskabsrum</option>
                                <option value="with">Med redskabsrum</option>
                            </select>
                        </label>
                        <div id="shedFields" class="form-subsection" style="display: none;">
                            <label>Redskabsrum bredde
                                <input type="number" name="shedWidth" th:value="${order.shedWidth}" placeholder="Angiv bredde i cm"/>
                            </label>
                            <label>Redskabsrum længde
                                <input type="number" name="shedLength" th:value="${order.shedLength}" placeholder="Angiv længde i cm"/>
                            </label>
                        </div>
                    </div>

                    <!-- Sketch section -->
                    <div class="sketch-section">
                        <h2>Skitse</h2>
                        <button type="button" onclick="updateSketch()">
                            Opdater skitse
                            <img src="../public/images/update_icon.png" th:src="@{/images/update_icon.png}" alt="Ikon"
                                 style="height: 20px; width: 20px; vertical-align: middle; margin-left: 8px;">
                        </button>
                        <h3>Carporten set ovenfra med spær</h3>
                        <div class="carport-svg-topview">
                            <div th:utext="${svg}"></div>
                        </div>
                    </div>

                    <div class="price-section">
                    <p>Vejledende pris: <span th:text="${order.price} + ' kr.'">0000 kr</span></p>
                        <input type="hidden" name="orderId" th:value="${order.orderId}"/>

                        <label for="orderPrice">Endelig pris:</label>
                        <input type="number" id="orderPrice" name="orderPrice" th:value="${order.price}" required/>

                        <!-- Material cost -->
                        <p>Pris på materialer: <span id="costPriceDisplay" th:text="${order.costPrice} + ' kr'">0 kr</span></p>

                        <!-- Calculator -->
                        <p>Dækningsbidrag: <span id="profitDisplay">0 kr</span></p>
                        <p>Dækningsgrad: <span id="marginDisplay">0%</span></p>

                        <!-- Save button -->
                        <button type="submit">Gem ændringerne
                        <img src="../public/images/save_icon.png" th:src="@{/images/save_icon.png}" alt="Ikon"
                             style="height: 20px; width: 20px; vertical-align: middle; margin-left: 8px;">
                    </button>

                    <button type="submit">Vis preview og send til kunden</button>
                    </div>
                </div>
            </form>
        </section>
    </div>
</main>

<footer>
    <div class="container footer-container">
        <p>Johannes Fog A/S</p>
        <p>Firskovvej 20</p>
        <p>2800 Lyngby</p>
        <p>CVR-nr. 16314439</p>
    </div>
</footer>
</body>
</html>
